syntax = "proto3";

package com.kodypay.grpc.preauth.v1;

option java_multiple_files = true;
option java_outer_classname = "KodyPreAuthProto";
option java_package = "com.kodypay.grpc.preauth.v1";
import "google/protobuf/timestamp.proto";
import "com/kodypay/grpc/common/enums.proto";

service KodyPreAuthTerminalService {
  // Initiates a pre-authorisation on a specific payment terminal.
  // The terminal will then prompt the customer to present their card.
  rpc PreAuthorise(PreAuthorisationRequest) returns (stream PreAuthorisationResponse);

  // Initiates a pre-authorisation using a stored card token.
  rpc PreAuthoriseWithCardToken(PreAuthoriseWithCardTokenRequest) returns (stream PreAuthorisationResponse);

  // Increases the authorised amount on an existing pre-authorisation.
  rpc TopUpAuthorisation(TopUpAuthorisationRequest) returns (stream TopUpAuthorisationResponse);

  // Captures the funds from an existing pre-authorisation to finalise a payment.
  rpc CaptureAuthorisation(CaptureAuthorisationRequest) returns (CaptureAuthorisationResponse);

  // Releases the hold on funds from an existing pre-authorisation.
  rpc ReleaseAuthorisation(ReleaseAuthorisationRequest) returns (ReleaseAuthorisationResponse);

  // Retrieves the current state and details of a pre-authorisation.
  rpc GetPreAuthorisation(GetPreAuthorisationRequest) returns (GetPreAuthorisationResponse);
}

// ==========================================================
// Pre Authorisation Messages
// ==========================================================

// Represents a request to initiate a pre-authorisation on a physical payment terminal.
message PreAuthorisationRequest {
  // A unique key for this specific request attempt, used for idempotency.
  string idempotency_uuid = 1;

  // Client's unique reference for this transaction. This will be echoed in the response.
  string pre_auth_reference = 2;

  // Client's internal identifier for the order, folio, or tab. This will also be echoed.
  optional string order_id = 3;

  // The Kody Store ID.
  string store_id = 4;

  // The unique identifier for the target payment terminal to be activated.
  string terminal_id = 5;

  // The amount to authorise, in minor units.
  uint64 amount_minor_units = 6;

  // ISO 4217 three-letter currency code.
  string currency = 7;

  // The method of payment initiation.
  optional PaymentMethodType payment_method_type = 8;
}

// Represents the response to a PreAuthorisationRequest.
message PreAuthorisationResponse {
  // Client's unique reference, echoed from the request.
  string pre_auth_reference = 1;

  // The PSP reference for this specific authorisation.
  string psp_reference = 2;

  // The client's order ID, echoed back if it was provided in the request.
  optional string order_id = 3;

  // A Kody-generated id representing this specific authorisation. It is deposit id in Kody system.
  string pre_auth_id = 4;

  // Details of the card used for this authorisation.
  optional PaymentCard card_details = 5;

  // Final status of the authorisation.
  AuthStatus status = 6;

  // The amount that was actually authorised in minor units.
  uint64 authorised_amount_minor_units = 7;

  // The currency of the authorised amount.
  string currency = 8;

  // The timestamp of when the authorisation was successfully created.
  google.protobuf.Timestamp created_at = 9;

  // The timestamp of when the authorisation was successfully created.
  optional google.protobuf.Timestamp authorised_at = 10;
}

// Represents a request to initiate a pre-authorisation using a card token.
message PreAuthoriseWithCardTokenRequest {
  // A unique key for this specific request attempt, used for idempotency.
  string idempotency_uuid = 1;

  // Client's unique reference for this transaction. This will be echoed in the response.
  string pre_auth_reference = 2;

  // Client's internal identifier for the order, folio, or tab. This will also be echoed.
  optional string order_id = 3;

  // The Kody Store ID.
  string store_id = 4;

  // The amount to authorise, in minor units.
  uint64 amount_minor_units = 5;

  // ISO 4217 three-letter currency code.
  string currency = 6;

  // The payment token representing the card to be charged.
  string payment_token = 7;

  // The expiry date of the card in MM/YY format.
  string expiry_date = 8;
}

// ==========================================================
// Top-Up Authorisation Messages
// ==========================================================

message TopUpAuthorisationRequest {
  string idempotency_uuid = 1;
  string top_up_reference = 2; // Client's unique reference for this specific top-up action.
  optional string order_id = 3; // The original order_id for context.
  string store_id = 4; // The Kody Store ID.

  // The id from the original successful PreAuthorisationResponse.
  string pre_auth_id = 5;

  // The *additional* amount to authorise in minor units.
  uint64 top_up_amount_minor_units = 6;
  string currency = 7;
}

message TopUpAuthorisationResponse {
  string top_up_reference = 1; // Echoed from request.
  string psp_reference = 2;
  optional string order_id = 3; // Echoed from request.

  // The new total amount authorised on the card after the top-up.
  optional uint64 total_authorised_amount_minor_units = 4;

  // The timestamp of when the authorisation was successfully topped_up.
  optional google.protobuf.Timestamp topped_up_at = 5;

  // The current status of the top-up operation.
  AuthStatus status = 6;
}

// ==========================================================
// Capture Authorisation Messages
// ==========================================================

message CaptureAuthorisationRequest {
  string idempotency_uuid = 1;
  string capture_reference = 2; // Client's unique reference for this capture action.
  optional string order_id = 3;
  string store_id = 4; // The Kody Store ID.

  // The id from the original successful PreAuthorisationResponse.
  string pre_auth_id = 5;

  // The final amount to capture in minor units. Can be <= total authorised amount.
  uint64 capture_amount_minor_units = 6;
  string currency = 7;
}

message CaptureAuthorisationResponse {
  string capture_reference = 1;
  string psp_reference = 2;
  optional string order_id = 3; // Echoed from request.
  // The timestamp of when the authorisation was successfully captured.
  google.protobuf.Timestamp captured_at = 4;
}

// ==========================================================
// Release Authorisation Messages
// ==========================================================

message ReleaseAuthorisationRequest {
  string idempotency_uuid = 1;
  string release_reference = 2; // Client's unique reference for this release action.
  optional string order_id = 3;
  string store_id = 4; // The Kody Store ID.

  // The preauth id from the original successful PreAuthorisationResponse.
  string pre_auth_id = 5;
}

message ReleaseAuthorisationResponse {
  string release_reference = 1;
  string psp_reference = 2;
  optional string order_id = 3; // Echoed from request.
  // The timestamp of when the authorisation was successfully released.
  google.protobuf.Timestamp released_at = 4;
}

// ==========================================================
// Get Pre-Authorisation Messages
// ==========================================================

// Request to retrieve the details of an existing pre-authorisation.
message GetPreAuthorisationRequest {
  // The Kody-generated, secure token representing the pre-authorisation.
  string pre_auth_id = 1;
}

// Response containing the full state of the pre-authorisation.
message GetPreAuthorisationResponse {
  // Client's unique reference for the transaction.
  string pre_auth_reference = 1;

  // The Kody-generated, secure token representing this specific authorisation.
  string pre_auth_id = 2;

  // The client's order ID, if it was provided in the original request.
  optional string order_id = 3;

  // The current status of the pre-authorisation.
  AuthStatus status = 4;

  // The current total authorised amount in minor units.
  uint64 total_authorised_amount_minor_units = 5;

  // The amount that has been captured, in minor units.
  optional uint64 captured_amount_minor_units = 6;

  // ISO 4217 three-letter currency code.
  string store_currency = 7;

  // Details of the card used for this authorisation.
  PaymentCard card_details = 8;

  // The timestamp of when the authorisation was successfully created.
  google.protobuf.Timestamp created_at = 9;

  // The timestamp of the last successful top-up, if any.
  optional google.protobuf.Timestamp last_topped_up_at = 10;

  // The timestamp of when the authorisation was captured, if applicable.
  optional google.protobuf.Timestamp captured_at = 11;

  // The timestamp of when the authorisation was released, if applicable.
  optional google.protobuf.Timestamp released_at = 12;

  // The timestamp of when the payment is successfully authorised.
  optional google.protobuf.Timestamp authorised_at = 13;

  // Any adjustments made to this pre-authorisation.
  repeated Adjustment adjustments = 14;
}

// --- Supporting Messages ---

enum AuthStatus {
  // The status is not specified. Should not be used.
  AUTH_STATUS_UNSPECIFIED = 0;
  PENDING_AUTHORISATION = 1;
  AUTHORISED = 2;
  DECLINED = 3;
  CANCELLED = 4;
  PENDING_CAPTURE = 5;
  CAPTURED = 6;
  CAPTURE_FAILED = 7;
  PENDING_RELEASE = 8;
  RELEASED = 9;
  RELEASE_FAILED = 10;
  PENDING_TOP_UP = 11;
  TOP_UP_FAILED = 12;
  EXPIRED = 13;
  // The transaction failed due to a technical error (e.g., network issue, PSP error).
  // This is for failures where the state is indeterminate.
  FAILED = 14;
}

// Contains non-sensitive details of the card used in a transaction.
message PaymentCard {
  string card_last_4_digits = 1;
  string card_expiry_date = 2;
  optional string pos_entry_mode = 3;

  // The token representing the card itself,
  // distinct from the pre_auth_id which represents this specific transaction.
  optional string payment_token = 4;

  com.kodypay.grpc.common.PaymentMethods payment_method = 5;
  optional string payment_method_variant = 6; // e.g. visa debit', 'visa international credit'
}

enum PaymentMethodType {
  CARD_PRESENT = 0;
  MOTO = 1; // Mail Order / Telephone Order
}

message Adjustment {
  string adjustment_id = 1; // Unique identifier for this adjustment.
  optional string adjustment_reference = 2; // Client's reference for the adjustment, if provided.
  AdjustmentStatus status = 3; // Current status of the adjustment.
  uint64 amount_minor_units = 4; // Amount of the adjustment in minor currency units.
  google.protobuf.Timestamp created_at = 5; // Timestamp when the adjustment was created.
  google.protobuf.Timestamp updated_at = 6; // Timestamp when the adjustment was last updated.
  optional string psp_reference = 7; // PSP reference for this adjustment, if available.
}

enum AdjustmentStatus {
  ADJUSTMENT_STATUS_UNSPECIFIED = 0;
  ADJUSTMENT_PENDING = 1;
  ADJUSTMENT_SUCCESS = 2;
  ADJUSTMENT_ERROR = 3;
}
