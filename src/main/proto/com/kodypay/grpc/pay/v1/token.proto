syntax = "proto3";
package com.kodypay.grpc.token.v1;
option java_multiple_files = true;
option java_outer_classname = "KodyTerminalTokenProto";
option java_package = "com.kodypay.grpc.token.v1";
import "google/protobuf/timestamp.proto";
import "com/kodypay/grpc/common/enums.proto";

// All service requests require X-API-Key header with 'API Key' value
service KodyTerminalTokenService {
  rpc CreateCardToken(CreateCardTokenRequest) returns (stream CreateCardTokenResponse);
  rpc GetCardToken(GetCardTokenRequest) returns (GetCardTokenResponse);
}

message CreateCardTokenRequest {
  string store_id = 1; // Your Kody store id
  string terminal_id = 2; // Terminal id where the tokenisation request is sent from, if applicable. Required when obtaining the token through the terminal.
  string idempotency_uuid = 3; // Idempotency key to ensure the request is processed only once, generated by client.
  string token_reference = 4; // Your unique reference for this token request, if applicable. This can be used to match the token with your internal systems.
  string payer_reference = 5; // The payer for whom the token is created, e.g. user id or any unique identifier you use to track users
}

message CreateCardTokenResponse {
  oneof result {
    TokenDetails response = 1;
    Error error = 2;
  }
}

message GetCardTokenRequest {
  string store_id = 1; // Your Kody store id
  oneof token_identifier {
    string token_id = 2; // The unique identifier created by Kody
    string token_reference = 3; // Your unique payment reference that was set during the initiation
  }
}

message GetCardTokenResponse {
  oneof result {
    TokenDetails response = 1;
    Error error = 2;
  }
}

message TokenDetails {
  string token_id = 1; // The unique identifier created by Kody
  string token_reference = 2; // the external payment reference associated with the stored payment method, if applicable
  optional string payment_token = 3; // Unique identifier for the stored payment method as created by Kody, e.g. a token that can be used for future payments
  string payer_reference = 4; // The payer for whom the token is created, e.g. user id or any unique identifier you use to track users
  optional com.kodypay.grpc.common.RecurringProcessingModel recurring_processing_model = 5; // Recurring processing model
  com.kodypay.grpc.common.CardTokenStatus status = 6; // Status of the token
  optional google.protobuf.Timestamp created_at = 7; // Date when the token was created
  optional CardInfo card_info = 8; // Card information

  message CardInfo {
    com.kodypay.grpc.common.PaymentMethods payment_method = 1; // Card brand, e.g. mc, visa and so on
    string payment_method_variant = 2; // Card variant, e.g. mccredit, mcdebit, visadebit, etc.
    string card_last_4_digits = 3; // Last four digits of the card number
    string card_expiry_date = 4; // Expiry date of the card
    string pos_entry_mode = 5; // POS entry mode of the card
  }
}

message Error {
  Type type = 1;
  string message = 2;

  enum Type {
    UNKNOWN = 0;
    DUPLICATE_ATTEMPT = 1;
    INVALID_REQUEST = 2;
  }
}
